<p-table #table [value]="coursesInGroup" [scrollable]="true" scrollHeight="flex" sortMode="multiple"
         [loading]="loading"
         [selectionMode]="'single'"
         [(selection)]="selected"
         [globalFilterFields]="columnFields"
         (onFilter)="selected=undefined"
         [columns]="columns"
         [expandedRowKeys]="expandedRows"
         class="mini-table"
         styleClass="p-datatable-gridlines"
         dataKey="course.id">
  <!--TABLE TOOLBAR-->
  <ng-template pTemplate="caption">
    <div class="table-toolbar">
      <div class="table-toolbar-left">
        <div class="mini-table-header">Курсы группы ({{coursesInGroup.length}})</div>

        <div class="splitter"></div>

        <p-button pTooltip="Показать / Скрыть фильтры" icon="pi pi-filter"
                  (click)="filter=!filter" styleClass="button-mini button-clear"></p-button>

        <div class="splitter"></div>

        <p-button pTooltip="Добавить курс для группы" icon="pi pi-plus"
                  (click)="addCoursePanel.toggle($event)"
                  styleClass="button-mini button-clear">
        </p-button>
        <p-button pTooltip="Удалить выбранный курс для группы" icon="pi pi-minus"
                  [disabled]="!selected"
                  (click)="removeCourseFromGroup()"
                  styleClass="button-mini button-clear">
        </p-button>
      </div>
    </div>
  </ng-template>

  <!--TABLE COLUMNS-->
  <ng-template pTemplate="header">
    <!--TABLE FILTER-->
    <tr *ngIf="filter">
      <th style="width: 2rem"></th>
      <th *ngFor="let col of columns">
        <app-column-filter-wrapper [column]="col"></app-column-filter-wrapper>
      </th>
    </tr>
  </ng-template>

  <!--TABLE DATA-->
  <ng-template pTemplate="body" let-row let-expanded="expanded">
    <tr [pSelectableRow]="row">
      <td style="position: relative; width: 2rem">
        <p-button type="button" [pRowToggler]="row" [text]="true"
                  pTooltip="Открыть список преподавателей"
                  [rounded]="true" [plain]="true" styleClass="no-bordered mini-table-expand-button"
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"/>
      </td>
      <ng-container *ngFor="let col of columns">
        @switch (col.type) {
          @case ("boolean") {
            <td style="text-align: center">
              <p-checkbox [binary]="true" [readonly]="true" [style]="{pointerEvents: 'none'}"
                          [(ngModel)]="row[col.fieldGetter ?? col.field]">
              </p-checkbox>
            </td>
          }
          @case ("date") {
            <td style="text-align: center">{{ getField(row, col) }}</td>
          }
          @default {
            <td [class.cell-center]="col.field == 'id'">{{ getField(row, col) }}</td>
          }
        }
      </ng-container>
    </tr>
  </ng-template>

  <ng-template pTemplate="rowexpansion" let-row>
    <tr>
      <td colspan="99" style="background: var(--primary-deep-alfa-color)">
        <div class="detail-content">
          <app-tutors-for-course-list [course]="row" [allTutors]="allTutors"></app-tutors-for-course-list>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="99">Ничего не найдено</td>
    </tr>
  </ng-template>
</p-table>

<p-overlayPanel #addCoursePanel>
  <form #form="ngForm" [class.content-disabled]="loading">
    <div class="detail-form-wrapper">
      <p-dropdown name="course" [options]="filteredCourses" [(ngModel)]="addingCourse"
                  optionLabel="name" [filter]="true"
                  [style]="{width: '100%', display: 'inline-flex'}"
                  placeholder="Выберите курс" [required]="true">
      </p-dropdown>
    </div>
  </form>

  <div class="detail-form-footer" [class.content-disabled]="loading">
    <p-button [label]="loading ? 'Подождите...' : 'Добавить курс'"
              styleClass="button-mini-with-label" [disabled]="!!form.invalid"
              (click)="addCourseToGroup()">
    </p-button>
  </div>
</p-overlayPanel>
