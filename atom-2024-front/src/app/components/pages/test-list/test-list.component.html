<div *ngIf="loading" class="full-width-height-center loader">
  <app-loader></app-loader>
</div>

<div class="full-width-height" [class.content-disabled]="loading" [class.content-hidden]="isHiddenMode"
     style="text-align: center; overflow: auto">
  <p-dataView #dv [value]="filteredTests" [emptyMessage]="loading ? ' ' : 'Нет доступных испытаний'">
    <ng-template pTemplate="header">
      <div class="table-toolbar">
        <div class="table-toolbar-left">
          <div>Испытания</div>
          <div class="splitter"></div>

          <p-button pTooltip="Обновить список" icon="pi pi-sync" (click)="getTestsFromApi()"
                    styleClass="button-primary"></p-button>

          <div class="splitter"></div>

          <p-button pTooltip="Начать новое испытание" icon="pi pi-plus"
                    severity="success" (click)="isMultiple = false; createDialogVisible = true">
          </p-button>

          <p-button pTooltip="Начать новое комбинированное испытание" icon="pi pi-table"
                    severity="success" (click)="isMultiple = true; createDialogVisible = true">
          </p-button>
        </div>
        <div class="table-toolbar-right">
          <div class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input pInputText type="text" placeholder="Быстрый поиск"
                   [(ngModel)]="globalFilterValue"/>
          </div>
          <p-selectButton *ngIf="!isMobileMode; else filterDropdown" [options]="filterByStatusOptions"
                          [(ngModel)]="filterByStatus" [allowEmpty]="false"
                          (onChange)="getTestsFromApi()"></p-selectButton>
          <ng-template #filterDropdown>
            <p-dropdown appendTo="body" scrollHeight="300" [options]="filterByStatusOptions"
                        [(ngModel)]="filterByStatus"
                        (onChange)="getTestsFromApi()"></p-dropdown>
          </ng-template>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="list" let-testGroups>
      <div [id]="'test-card-' + item.id" class="test-card" *ngFor="let item of testGroups; let first = first">
        <div class="test-item">
          <p-button *ngIf="!item.printMode" styleClass="button-clear bordered"
                    pTooltip="Посмотреть подробные результаты"
                    [style]="{height: '100%', width: '200px'}"
                    icon="pi pi-search"
                    [label]="getLabelForGroup(item)" (click)="item.showResult = !item.showResult">
          </p-button>
          <div class="test-item-details">
            <h4 *ngIf="!item.printMode">{{ getProductLabel(item) }}</h4>

            <ng-container *ngIf="item.printMode">
              <h2 style="text-align: center; margin-bottom: 0">Карточка испытания</h2>
              <h4 style="padding-bottom: 20px; text-align: center">{{ getLabelForGroup(item) }}</h4>
              <div style="display: inline-flex">ДСЕ: {{ getTypeLabel(item) }}</div>
            </ng-container>

            <div style="display: inline-flex; gap: 5px">Статус:
              <ng-container *ngIf="item.printMode; else tag">{{ getLabel(item) }}</ng-container>
              <ng-template #tag>
                <p-tag [value]="getLabel(item)" [severity]="getSeverity(item)"></p-tag>
              </ng-template>
            </div>
            <div style="display: inline-flex">{{ getTypeLabel(item) }}</div>
            <div style="display: inline-flex">Инициатор: {{ item.startUser.shortName }}</div>
            <div style="display: inline-flex">Дата запуска: {{ getDate(item.startDate) }}</div>
            <ng-container *ngIf="item.isBusy && !item.printMode; else lastDate">
              <div style="flex: auto"></div>
              <p-progressBar mode="indeterminate"
                             [style]="{width: '100%', height: '6px'}">
              </p-progressBar>
            </ng-container>
            <ng-template #lastDate>
              <div style="display: inline-flex">Дата
                завершения: {{ item.endDate == null ? "" : getDate(item.endDate) }}
              </div>
              <div style="display: inline-flex">Время
                выполнения: {{ item.endDate == null ? "" : item.executionSeconds + " сек." }}
              </div>
            </ng-template>
          </div>
          <div *ngIf="!item.printMode" class="test-item-controls">
            <p-button styleClass="button-mini" pTooltip="Повторить испытание с теми же параметрами"
                      (click)="copyTestGroup(item)"
                      icon="pi pi-clone"></p-button>

            <p-button *ngIf="item.isBusy" styleClass="button-mini"
                      pTooltip="Остановить испытание" icon="pi pi-stop-circle"
                      (click)="cancelTestGroup(item)"
                      severity="danger">
            </p-button>

            <p-button styleClass="button-mini"
                      pTooltip="Печать карточки испытания" icon="pi pi-file-pdf"
                      (click)="printCard(item)"
                      severity="success">
            </p-button>
          </div>
        </div>

        <hr *ngIf="item.showResult || item.printMode">
        <div *ngIf="item.showResult || item.printMode" class="test-result-card">
          <ng-container *ngIf="item.printMode; else tabView">
            <ng-container *ngFor="let itemTest of item.tests">
              <div style="display: inline-flex; padding-top: 20px">Детализация: {{ itemTest.standEndpoint?.name ?? itemTest.id }}</div>
              <hr>
              <div [class.padding-left-20]="item.printMode">
                <ng-container *ngTemplateOutlet="resultGroupItem; context: {$implicit: itemTest}"></ng-container>
              </div>
            </ng-container>
          </ng-container>

          <ng-template #tabView>
            <p-tabView [scrollable]="true">
              <ng-container *ngFor="let itemTest of item.tests">
                <p-tabPanel>
                  <ng-template pTemplate="header">
                    <span>{{ itemTest.standEndpoint?.name ?? itemTest.id }}</span>
                    <i [class]="getIcon(itemTest)" style="margin-left: 5px"></i>
                  </ng-template>

                  <ng-container *ngTemplateOutlet="resultGroupItem; context: {$implicit: itemTest}">
                  </ng-container>
                </p-tabPanel>
              </ng-container>
            </p-tabView>
          </ng-template>
        </div>
        <hr>
      </div>
    </ng-template>
  </p-dataView>
</div>

<app-test-registration-form *ngIf="createDialogVisible"
                            [isMultiple]="isMultiple"
                            (result)="onCreateTestResult($event)">
</app-test-registration-form>

<ng-template #resultGroupItem let-itemTest>
  <div class="result-wrapper">
    <div class="result-left margin-t-5">
      <div>Описание: {{ itemTest.standEndpoint.description }}</div>
      <div>Тип: {{ getTestType(itemTest) }}</div>
      <div>ДСЕ: {{ itemTest.product.caption }}</div>

      <div class="v-splitter-10"></div>

      <div>
        Статус:
        <ng-container *ngIf="loading; else tag">{{ getTestStatusLabel(itemTest) }}</ng-container>
        <ng-template #tag>
          <p-tag [value]="getTestStatusLabel(itemTest)"
                 [severity]="getTestSeverity(itemTest)">
          </p-tag>
        </ng-template>
      </div>
      <div>Дата регистрации: {{ getDate(itemTest.registrationDate) }}</div>
      <div>Дата начала: {{ getDate(itemTest.executionStartDate) }}</div>
      <div>Дата завершения: {{ itemTest.executionEndDate == null ? "" : getDate(itemTest.executionEndDate) }}</div>
      <div class="v-splitter-10"></div>
      <div>Время выполнения: {{ itemTest.executionEndDate == null ? "" : (itemTest.executionSeconds + ' сек.') }}</div>
      <div><b>Испытатель:</b> {{ itemTest.executorShortName }}</div>
    </div>
    <div class="result-right margin-t-5" style="padding-left: 30px">
      <label><b>Входные параметры:</b></label>
      <div class="v-splitter-5"></div>
      <div *ngFor="let inParam of parseInTestData(itemTest)">
        <div style="padding-left: 30px">{{ inParam.label }}: {{ inParam.value }}</div>
      </div>

      <div class="v-splitter-5"></div>

      <label><b>Результаты:</b></label>
      <div class="v-splitter-5"></div>
      <div *ngFor="let outParam of parseOutTestData(itemTest)">
        <div style="padding-left: 30px">{{ outParam.label }}: {{ outParam.value }}</div>
      </div>
    </div>
  </div>
</ng-template>
