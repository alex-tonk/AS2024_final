<div *ngIf="loading" class="full-width-height-center loader">
  <app-loader></app-loader>
</div>

<p-table #table [value]="tests" [scrollable]="true" scrollHeight="flex" sortMode="multiple"
         [loading]="loading"
         [selectionMode]="'single'"
         [(selection)]="selectedTest"
         [globalFilterFields]="columnFields"
         (onFilter)="selectedTest=undefined"
         [resizableColumns]="true"
         [columns]="columns"
         [reorderableColumns]="true"
         [virtualScroll]="true"
         styleClass="p-datatable-gridlines"
         dataKey="id">
  <!--TABLE TOOLBAR-->
  <ng-template pTemplate="caption">
    <div class="table-toolbar">
      <div class="table-toolbar-left">
        <div style="display: inline-flex; align-items: center; gap: 5px">Выберите период:
          <p-selectButton [options]="filtersByRegDate"
                          [(ngModel)]="filterByRegDate" [allowEmpty]="false">
          </p-selectButton>
        </div>
      </div>

      <div class="table-toolbar-right">
        <div>{{ dateFilterInfo }}</div>
        <p-button label="Загрузить данные" pTooltip="Загрузить данные за выбранный период"
                  icon="pi pi-play" (click)="getDataFromApi()"
                  styleClass="button-primary"></p-button>
        <p-button label="Печать" icon="pi pi-print" [disabled]="!fetchedData"
                  (click)="menu.toggle($event)" severity="success"></p-button>
      </div>
    </div>
  </ng-template>

  <!--TABLE COLUMNS-->
  <ng-template pTemplate="header">
    <tr *ngIf="fetchedData">
      <ng-container *ngFor="let col of columns">
        <th [style]="{width: col.width+'%'}" [pSortableColumn]="col.field" pResizableColumn pReorderableColumn>
          {{ col.header }}
          <p-sortIcon [field]="col.field"></p-sortIcon>
        </th>
      </ng-container>
    </tr>
    <!--TABLE FILTER-->
    <tr *ngIf="filter">
      <th *ngFor="let col of columns">
        <app-column-filter-wrapper [column]="col"></app-column-filter-wrapper>
      </th>
    </tr>
  </ng-template>

  <!--TABLE DATA-->
  <ng-template pTemplate="body" let-row>
    <tr *ngIf="fetchedData" [pSelectableRow]="row">
      <ng-container *ngFor="let col of columns">
        @switch (col.type) {
          @case ("boolean") {
            <td style="text-align: center">
              <p-checkbox [binary]="true" [readonly]="true" [style]="{pointerEvents: 'none'}"
                          [(ngModel)]="row[col.fieldGetter ?? col.field]">
              </p-checkbox>
            </td>
          }
          @case ("date") {
            <td style="text-align: center">{{ getDate(row[col.field]) }}</td>
          }
          @case ("testType") {
            <td>{{ getTestType(row) }}</td>
          }
          @default {
            <td [class.cell-center]="col.field == 'id'">{{ getFieldValue(row, col.field) }}</td>
          }
        }
      </ng-container>
    </tr>
  </ng-template>

  <!--TABLE SUMMARY-->
  <ng-template pTemplate="summary">
    <div *ngIf="fetchedData" class="table-toolbar">
      <div class="table-toolbar-left">
        Всего найдено записей: {{ tests.length }}
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr *ngIf="fetchedData">
      <td colspan="99">Ничего не найдено</td>
    </tr>
  </ng-template>
</p-table>

<p-menu #menu [model]="(ExportTable.exportMenu | async)!" [popup]="true"
        (onShow)="ExportTable.showMenu(table, columns, tests, getFileName)"
        appendTo="body">
</p-menu>
